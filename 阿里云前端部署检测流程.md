# 阿里云前端部署检测流程（本 App tpc.jingyanrong.com）

当 **coolpropapi.jingyanrong.com** 已确认无问题，但本前端 App 在阿里云上有异常时，按以下步骤排查 **tpc.jingyanrong.com** 的部署配置。

---

## 一、部署架构说明

| 项目 | 域名 | 部署位置 | 说明 |
|------|------|----------|------|
| **本前端** Thermophysical-Property-Calls | tpc.jingyanrong.com | 阿里云（静态文件） | 由 GitHub Actions rsync 到服务器 |
| **API** coolprop-api | coolpropapi.jingyanrong.com | 独立部署 | 前端通过浏览器直连，不经阿里云转发 |

本前端的阿里云只负责提供 **HTML/CSS/JS 静态文件**，API 请求由**浏览器直接**发往 coolpropapi.jingyanrong.com。

---

## 二、检测步骤

### 步骤 1：确认前端页面能否打开

浏览器访问：`https://tpc.jingyanrong.com`（或 `http://` 若未配 SSL）

**预期**：看到「Thermophysical Property — CoolProp 物性查询」界面。

- **白屏**：JS 加载失败、路径错误或控制台有报错，进入步骤 2。
- **404**：Nginx 未找到站点或根目录错误，进入步骤 5。
- **正常**：进入步骤 2。

---

### 步骤 2：确认前端实际请求的 API 地址

打开浏览器 **开发者工具**（F12）→ **Network** 面板，在页面进行一次「计算」操作，查看请求的 URL。

**预期**：请求地址为 `https://coolpropapi.jingyanrong.com/api/props` 或 `/api/humid-air/props`。

- **若不是**（如 `tpc.jingyanrong.com/api/...` 或 `localhost`）：构建时 API 地址错误，进入步骤 6。
- **若是**：前端配置正确，问题在 API 或 CORS，进入步骤 3。

---

### 步骤 3：检查 CORS（若 API 地址正确却请求失败）

在 **Console** 中查看是否有跨域错误，例如：

```
Access to fetch at 'https://coolpropapi.jingyanrong.com/...' from origin 'https://tpc.jingyanrong.com' has been blocked by CORS policy
```

- **有 CORS 报错**：需在 **coolprop-api** 中配置允许 `tpc.jingyanrong.com` 的 Origin（与本前端阿里云配置无关）。
- **无 CORS 报错**：跨域正常，可排除此项。

---

### 步骤 4：刷新页面是否 404（SPA 路由）

访问 `https://tpc.jingyanrong.com` 后，按 F5 刷新，或直接访问 `https://tpc.jingyanrong.com/`。

**预期**：正常显示页面，不出现 Nginx 404。

- **刷新后 404**：Nginx 缺少 SPA 回退配置，进入步骤 5。
- **正常**：Nginx 路由配置基本正确。

---

### 步骤 5：检查 Nginx 配置（需 SSH 登录阿里云）

登录阿里云服务器后执行：

```bash
# 查找 tpc 相关配置
grep -r "tpc" /etc/nginx/ 2>/dev/null || grep -r "tpc" /www/server/panel/vhost/nginx/ 2>/dev/null
```

确认配置中包含：

```nginx
server {
    server_name tpc.jingyanrong.com;
    root /www/wwwroot/tpc.jingyanrong.com;   # 或你的实际部署路径
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;   # 必须：SPA 刷新不 404
    }

    # 静态资源缓存（可选）
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**检查点**：

| 项目 | 正确 | 错误示例 |
|------|------|----------|
| `root` | 与 GitHub Secret `ALIYUN_DEPLOY_PATH` 一致 | 路径错误或指向空目录 |
| `try_files ... /index.html` | 有 | 缺失会导致刷新 404 |
| 无 `location /api/` | 本前端不代理 API | 若代理到错误地址会导致 API 请求异常 |

---

### 步骤 6：检查构建时的 API 地址

本前端在**构建时**将 API 地址写入 JS，部署后无法通过环境变量修改。

在 **GitHub 仓库** → **Actions** → 最近一次「Deploy to Aliyun」→ 查看 **Build** 步骤的 env：

- 当前 workflow **未设置** `VITE_API_URL`，会使用代码默认值 `https://coolpropapi.jingyanrong.com`。
- 若需修改，在 `deploy-aliyun.yml` 的 Build 步骤中增加：

```yaml
- name: Build
  run: npm run build
  env:
    VITE_BASE_PATH: /
    VITE_API_URL: https://coolpropapi.jingyanrong.com   # 显式指定
```

修改后需 **重新触发部署**，新构建才会生效。

---

### 步骤 7：确认部署目录内容

SSH 登录阿里云后执行：

```bash
# 替换为你的实际路径（与 ALIYUN_DEPLOY_PATH 一致）
ls -la /www/wwwroot/tpc.jingyanrong.com/
```

**预期**：存在 `index.html`、`assets/` 目录。

```bash
# 检查 index.html 时间戳是否为最近部署
ls -la /www/wwwroot/tpc.jingyanrong.com/index.html

# 检查主 JS 中是否包含正确的 API 地址
grep -r "coolpropapi" /www/wwwroot/tpc.jingyanrong.com/assets/*.js 2>/dev/null | head -1
```

- **无 index.html**：部署失败或路径错误，检查 GitHub Actions 日志与 Secrets。
- **时间戳很旧**：可能未成功部署，重新跑一次 workflow。
- **grep 无 coolpropapi**：构建时 API 地址可能被替换，检查构建配置。

---

### 步骤 8：检查 GitHub Actions Secrets

在 **GitHub 仓库** → **Settings** → **Secrets and variables** → **Actions** 中确认：

| Secret | 说明 | 建议值 |
|--------|------|--------|
| `ALIYUN_HOST` | 阿里云服务器 IP | 如 `8.138.191.154` |
| `ALIYUN_USER` | SSH 用户名 | 如 `admin` |
| `ALIYUN_DEPLOY_PATH` | 网站根目录 | 如 `/www/wwwroot/tpc.jingyanrong.com` |
| `ALIYUN_SSH_KEY` | SSH 私钥 | 完整私钥内容 |

`ALIYUN_DEPLOY_PATH` 必须与 Nginx 的 `root` 一致。

---

### 步骤 9：手动触发一次部署

1. **GitHub 仓库** → **Actions** → **Deploy to Aliyun**
2. **Run workflow** → 选 `main` → **Run workflow**
3. 等待完成后，再访问 `https://tpc.jingyanrong.com` 测试。

若 Actions 成功但页面仍异常，多为 Nginx 配置或缓存问题。

---

### 步骤 10：排除浏览器与 CDN 缓存

- 使用 **无痕/隐私模式** 或 **硬刷新**（Ctrl+Shift+R / Cmd+Shift+R）访问。
- 若使用 CDN，在 CDN 控制台执行**刷新缓存**。

---

## 三、快速诊断命令汇总

在**本地**执行（检查线上前端与 API）：

```bash
echo "=== 1. 前端页面可达性 ==="
curl -s -o /dev/null -w "%{http_code}" https://tpc.jingyanrong.com/
echo ""

echo "=== 2. 前端 index.html ==="
curl -s https://tpc.jingyanrong.com/ | head -5

echo "=== 3. API 根路径（对照） ==="
curl -s -o /dev/null -w "%{http_code}" https://coolpropapi.jingyanrong.com/
echo ""
```

**解读**：

- 1 为 200：前端站点可访问。
- 2 含 `<!doctype html>` 或 `index.html`：静态资源正常。
- 3 为 200：API 可访问（与本前端阿里云部署无关，仅作对照）。

---

## 四、结论对照

| 现象 | 可能原因 | 处理 |
|------|----------|------|
| 白屏 | JS 路径错误、base path 错误、构建产物异常 | 检查 vite base、部署路径、控制台报错 |
| 刷新 404 | Nginx 缺 `try_files ... /index.html` | 按步骤 5 修改 Nginx |
| 请求到错误 API 地址 | 构建时 VITE_API_URL 错误 | 按步骤 6 修改 workflow 并重新部署 |
| 部署目录为空或旧 | rsync 失败、Secrets 错误 | 检查 Actions 日志、Secrets、步骤 8 |
| CORS 报错 | API 未允许 tpc.jingyanrong.com | 在 coolprop-api 中配置 CORS |

---

## 五、与本项目相关的 Aliyun 配置小结

本前端在阿里云上**仅需**：

1. **Nginx**：`server_name tpc.jingyanrong.com`，`root` 指向部署目录，`location /` 使用 `try_files ... /index.html`。
2. **GitHub Actions**：正确配置 4 个 Secrets，Build 时使用正确的 `VITE_API_URL`（或不设置以使用默认值）。
3. **部署目录**：与 Nginx `root`、`ALIYUN_DEPLOY_PATH` 三者一致。

本前端**不**代理 API，API 请求由浏览器直接发往 coolpropapi.jingyanrong.com，因此阿里云上**不需要**配置 `/api/` 转发。
